<section class="vs-event--page bg-color6 space z-index-common">
  <div class="vs-event--ele1">
    <img
      src="/assets/img/elements/events-page-ele1.png"
      alt="event page ele1"
    />
  </div>
  <div class="vs-event--ele2">
    <img
      src="/assets/img/elements/events-page-ele2.png"
      alt="event page ele1"
    />
  </div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="vs-title text-center title-anime animation-style2">
          <div class="title-anime__wrap">
            <h5 class="vs-title__main">Scan Untuk Bermain!</h5>
            <span class="vs-title__sub">Boleh di sentuh atau tidak?</span>
          </div>
          <div class="vh-full p-3 camera-area">
            <div class="card scanner-card bg-dark text-light">
              <div class="card-body p-0">
                <div class="col-12 g-0">
                  <div class="col-12 btn-area">
                    <div id="reader" class="bg-black">
                      <div id="reader" class="bg-black position-relative"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div
            class="container quiz-area py-5 text-center"
            style="display: none"
          >
            <div class="d-flex justify-content-center align-items-center gap-4">
              <!-- Gambar di Tengah -->
              <div>
                <img id="quiz-img" src="" class="mb-3" />
                <div class="vs-event__btn">
                  <button class="vs-btn answer-btn">
                    <span class="vs-btn__border"></span>Apakah Boleh Disentuh?
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="vs-title text-center title-anime animation-style2">
        <div class="title-anime__wrap">
          <h5 class="vs-title__main" id="modalTitle">
            Aku Sayang Diriku, Jadi Aku Jaga Diriku
          </h5>
        </div>
      </div>

      <div class="img">
        <img
          id="resultImage"
          src=""
          alt="result"
          class="img-fluid result-animate"
        />
      </div>

      <div class="vs-event__btn mt-3">
        <button class="vs-btn btn-back" data-bs-dismiss="modal">
          <span class="vs-btn__border"></span>Kembali
        </button>
      </div>

      <audio id="audio-question" src=""></audio>
    </div>
  </div>
</div>

<script>
  $(function () {
    // ==============================
    // FIX DUPLICATE ID #reader
    // ==============================
    $("#reader").each(function (index) {
      if (index > 0) {
        $(this).attr("id", "reader-" + index);
      }
    });

    let html5QrCode = null;
    let camerasList = [];
    let currentCameraIndex = 0;
    let questionData = [];
    let q;
    let scannedOnce = false;

    $.getJSON("/constants/hear.json", function (data) {
      questionData = data;
    });

    function showResult(text) {
      if (!text || scannedOnce) return;
      scannedOnce = true;

      const baseUrl = "https://toddle.pixelionsolution.com?id=";

      if (!text.startsWith(baseUrl)) {
        alert("QR code tidak valid untuk aplikasi ini.");
        restartScanner();
        return;
      }

      const urlParams = new URL(text);
      const scannedId = urlParams.searchParams.get("id");

      if (!scannedId) {
        alert("ID tidak ditemukan dalam QR code.");
        restartScanner();
        return;
      }

      const found = questionData.find((item) => item.id == scannedId);
      if (!found) {
        alert("Data untuk ID ini tidak ditemukan.");
        restartScanner();
        return;
      }

      q = found;
      loadQuiz(found);
    }

    function loadQuiz(data) {
      $("#resultImage").attr("src", data.answer
        ? "/assets/gif/mendengar/check.gif"
        : "/assets/gif/mendengar/cross.gif"
      );

      $("#modalTitle").text(data.answer ? "Boleh Disentuh" : "Jangan Disentuh");
      $("#quiz-img").attr("src", data.questionImg);
      $("#audio-question").attr("src", data.audio);
      $(".quiz-area").fadeIn(300);
      $(".camera-area").fadeOut(300);
    }

    function handleError(err) {
      console.error(err);
    }

    function restartScanner() {
      scannedOnce = false;
    }

    function isMobile() {
      return /Android|iPhone|iPad|iPod|Windows Phone/i.test(
        navigator.userAgent
      );
    }

    // ===========================
    // GET CAMERA LIST
    // ===========================
    function scanCameras() {
      Html5Qrcode.getCameras()
        .then((cams) => {
          camerasList = cams || [];
          currentCameraIndex = 0;
          startScanner();
        })
        .catch(handleError);
    }

    // ===========================
    // START CAMERA SCANNER
    // ===========================
    async function startScanner() {
      try {
        const cameraId = camerasList[currentCameraIndex]?.id;
        if (!cameraId) return;

        // Stop scanner if already running
        if (html5QrCode) {
          try {
            await html5QrCode.stop();
          } catch (e) {}
          try {
            html5QrCode.clear();
          } catch (e) {}
        }

        html5QrCode = new Html5Qrcode("reader");

        const config = {
          fps: 10,
          qrbox: { width: 300, height: 300 },
          experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        };

        await html5QrCode.start(
          cameraId,
          config,
          (decodedText) => showResult(decodedText),
          () => {}
        );

        scannedOnce = false;
      } catch (e) {
        console.error(e);
      }
    }

    // ===========================
    // FLIP CAMERA (MOBILE ONLY)
    // ===========================
    if (isMobile()) {
      const flipBtn = $(`
        <button id="flipCameraBtn" 
          class="btn btn-outline-light position-absolute d-flex justify-content-center align-items-center"
          style="
            bottom: 10px;
            right: 10px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            backdrop-filter: blur(5px);
            background: rgba(255,255,255,0.15);
            z-index: 9999;
          ">
          <i class="bi bi-arrow-clockwise"></i>
        </button>
      `);

      $(".btn-area").append(flipBtn);

      flipBtn.on("click", async function () {
        if (!camerasList.length) return;

        currentCameraIndex = (currentCameraIndex + 1) % camerasList.length;

        await startScanner();
      });
    }

    // INITIAL START
    scanCameras();

    // ===========================
    // MODAL & AUDIO HANDLING
    // ===========================
    $(document).ready(function () {
      $(".modal").on("shown.bs.modal", function () {
        const audio = $("#audio-question")[0];
        audio.currentTime = 0;
        audio.play();
      });

      $(".answer-btn").click(function () {
        scannedOnce = true;
        const modal = new bootstrap.Modal(
          document.getElementById("resultModal")
        );
        modal.show();
      });

      $(".btn-back").click(function () {
        $("#modalTitle").text("");
        $("#quiz-img").attr("src", "");
        $("#audio-question").attr("src", "");

        $(".quiz-area").fadeOut(300);
        $(".camera-area").fadeIn(300);

        restartScanner();
        startScanner();
      });
    });

    // ===========================
    // RESUME SCANNER WHEN TAB ACTIVE
    // ===========================
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "visible") {
        restartScanner();
        scanCameras();
      }
    });
  });
</script>
