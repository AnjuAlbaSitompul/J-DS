<section class="vs-event--page bg-color6 space z-index-common">
  <div class="vs-event--ele1">
    <img
      src="/assets/img/elements/events-page-ele1.png"
      alt="event page ele1"
    />
  </div>
  <div class="vs-event--ele2">
    <img
      src="/assets/img/elements/events-page-ele2.png"
      alt="event page ele1"
    />
  </div>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        <div class="vs-title text-center title-anime animation-style2">
          <div class="title-anime__wrap">
            <h5 class="vs-title__main">Scan Untuk Bermain!</h5>
            <span class="vs-title__sub">Boleh di sentuh atau tidak?</span>
          </div>
          <div class="vh-full p-3 camera-area">
            <div class="card scanner-card bg-dark text-light">
              <div class="card-body p-0">
                <div class="col-12 g-0">
                  <div class="col-12 btn-area">
                    <div id="reader" class="bg-black">
                      <div id="reader" class="bg-black position-relative"></div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="card-footer text-center">
                <div>
                  <h5 class="mb-0" id="result">Scan a QR code to see the result</h5>
                </div>
              </div>
            </div>
          </div>
          <div
            class="container quiz-area py-5 text-center"
            style="display: none"
          >
            <div class="d-flex justify-content-center align-items-center gap-4">
              <!-- Tombol Sebelumnya -->
              <div class="nav-btn btn-prev">
                <i class="fa-solid fa-arrow-left"></i>
              </div>

              <!-- Gambar di Tengah -->
              <div>
                <img id="quiz-img" src="" class="mb-3" />
                <div class="vs-event__btn">
                  <button class="vs-btn answer-btn">
                    <span class="vs-btn__border"></span>Apakah Boleh Disentuh?
                  </button>
                </div>
              </div>

              <!-- Tombol Selanjutnya -->
              <div class="nav-btn btn-next-question">
                <i class="fa-solid fa-arrow-right"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <div class="vs-title text-center title-anime animation-style2">
        <div class="title-anime__wrap">
          <h5 class="vs-title__main" id="modalTitle">
            Aku Sayang Diriku, Jadi Aku Jaga Diriku
          </h5>
        </div>
      </div>

      <div class="img">
        <img
          id="resultImage"
          src=""
          alt="result"
          class="img-fluid result-animate"
        />
      </div>

      <div class="vs-event__btn mt-3">
        <button class="vs-btn btn-next" data-bs-dismiss="modal">
          <span class="vs-btn__border"></span>Selanjutnya!
        </button>
      </div>

      <audio id="audio-question" src=""></audio>
    </div>
  </div>
</div>

<script>
  $(function () {
    const resultEl = $("#result");

    let html5QrCode = null;
    let camerasList = [];
    let currentCameraIndex = 0;
    let questionData = [];
    let q;

    $.getJSON("/constants/hear.json", function (data) {
      questionData = data;
    });

    function showResult(text) {
        resultEl.text("Hasil Scan: " + text);
      if (!text) return;
      const baseUrl = "https://toddle.pixelionsolution.com/?id=";
      if (!text.startsWith(baseUrl)) {
        return;
      }
      const urlParams = new URL(text);
      const scannedId = urlParams.searchParams.get("id");

      if (!scannedId) {
        return;
      }
      const found = questionData.find((item) => item.id == scannedId);
      if (!found) {
        return;
      }
      q = found;
      loadQuiz();
    }

    function loadQuiz() {
      $("#result-img").attr("src", function () {
        return q.answer
          ? "/assets/gif/mendengar/check.gif"
          : "/assets/gif/mendengar/cross.gif";
      });
      $("#modalTitle").text(q.answer ? "Boleh Disentuh" : "Jangan Disentuh");
      $("#quiz-img").attr("src", q.questionImg);
      $("#audio-question").attr("src", q.audio);
      $(".quiz-area").fadeIn(300);
      $(".camera-area").fadeOut(300);
    }

    function handleError(err) {
      console.error(err);
      showResult("Error: " + (err?.message || err));
    }

    function isMobile() {
      return /Android|iPhone|iPad|iPod|Windows Phone/i.test(
        navigator.userAgent
      );
    }

    // ===========================
    // SCAN CAMERA LIST
    // ===========================
    function scanCameras() {
      Html5Qrcode.getCameras()
        .then((cams) => {
          camerasList = cams || [];
          // otomatis set kamera pertama + index
          currentCameraIndex = 0;
          startScanner();
        })
        .catch(handleError);
    }

    // ===========================
    // START SCANNER
    // ===========================
    async function startScanner() {
      try {
        const cameraId = camerasList[currentCameraIndex]?.id;
        if (!cameraId) return;

        if (html5QrCode) {
          await html5QrCode.stop();
          html5QrCode.clear();
        }

        html5QrCode = new Html5Qrcode("reader");

        const config = {
          fps: 10,
          qrbox: { width: 300, height: 300 },
          experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        };

        await html5QrCode.start(
          cameraId,
          config,
          (decodedText) => showResult(decodedText),
          () => {}
        );
      } catch (e) {
        handleError(e);
      }
    }

    // ===========================
    // FLIP CAMERA (MOBILE ONLY)
    // ===========================
    if (isMobile()) {
      const flipBtn = $(`
    <button id="flipCameraBtn" 
      class="btn btn-outline-light position-absolute d-flex justify-content-center align-items-center"
      style="
        bottom: 10px;
        right: 10px;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        backdrop-filter: blur(5px);
        background: rgba(255,255,255,0.15);
        z-index: 9999;
      ">
      <i class="bi bi-arrow-clockwise"></i>
    </button>
  `);

      $(".btn-area").append(flipBtn);

      flipBtn.on("click", function () {
        if (!camerasList.length) return;

        currentCameraIndex = (currentCameraIndex + 1) % camerasList.length;

        startScanner();
      });
    }

    // INITIAL
    scanCameras();
    $(".modal").on("shown.bs.modal", function () {
      const audio = $("#audio-question")[0];
      audio.currentTime = 0;
      audio.play();
    });

    // refresh camera when back to tab
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "visible") scanCameras();
    });
  });
</script>
