<div class="vh-full p-3">
  <div class="card scanner-card bg-dark text-light">
    <div class="card-body p-0">
      <div class="row g-0">
        <div class="col-12 col-lg-7">
          <div id="reader" class="bg-black">
            <div id="reader" class="bg-black position-relative">
            </div>
          </div>
        </div>
        <div class="col-12 col-lg-5">
          <div class="p-3 d-flex flex-column h-100">
            <h5 class="mb-2">Scan Qr Untuk Mulai Game</h5>
            <p class="small-muted">
              Buka izin kamera dan pilih kamera depan/belakang jika tersedia.
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(function () {
    const resultEl = $("#result");
    const cameraSelect = $("#cameraSelect");
    const startBtn = $("#startBtn");
    const stopBtn = $("#stopBtn");
    const copyBtn = $("#copyBtn");
    const toggleTorchBtn = $("#toggleTorch");

    let html5QrCode = null;
    let camerasList = [];
    let currentCameraIndex = 0;
    let isTorchOn = false;

    function showResult(text) {
      resultEl.text(text || "-");
    }

    function handleError(err) {
      console.error(err);
      showResult("Error: " + (err?.message || err));
    }

    function isMobile() {
      return /Android|iPhone|iPad|iPod|Windows Phone/i.test(
        navigator.userAgent
      );
    }

    // ===========================
    // SCAN CAMERA LIST
    // ===========================
    function scanCameras() {
      Html5Qrcode.getCameras()
        .then((cams) => {
          camerasList = cams || [];
          cameraSelect.empty();

          if (!camerasList.length) {
            cameraSelect.append("<option>No camera found</option>");
            return;
          }

          camerasList.forEach((cam) => {
            cameraSelect.append(
              $("<option>")
                .val(cam.id)
                .text(cam.label || cam.id)
            );
          });

          // otomatis set kamera pertama + index
          currentCameraIndex = 0;
          cameraSelect.val(camerasList[currentCameraIndex].id);

          // auto-start
          startScanner();
        })
        .catch(handleError);
    }

    // ===========================
    // START SCANNER
    // ===========================
    async function startScanner() {
      try {
        const cameraId = camerasList[currentCameraIndex]?.id;
        if (!cameraId) return;

        if (html5QrCode) {
          await html5QrCode.stop();
          html5QrCode.clear();
        }

        html5QrCode = new Html5Qrcode("reader");

        const config = {
          fps: 10,
          qrbox: { width: 300, height: 300 },
          experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        };

        await html5QrCode.start(
          cameraId,
          config,
          (decodedText) => showResult(decodedText),
          () => {}
        );

        // Torch capability
        try {
          const capabilities = await Html5Qrcode.getCameraCapabilities(
            cameraId
          );
          if (capabilities?.torch) toggleTorchBtn.show();
          else toggleTorchBtn.hide();
        } catch {
          toggleTorchBtn.hide();
        }
      } catch (e) {
        handleError(e);
      }
    }

    // ===========================
    // STOP SCANNER
    // ===========================
    async function stopScanner() {
      if (!html5QrCode) return;
      try {
        await html5QrCode.stop();
        html5QrCode.clear();
        html5QrCode = null;
        showResult("-");
      } catch (e) {
        handleError(e);
      }
    }

    // ===========================
    // TORCH
    // ===========================
    async function toggleTorch() {
      if (!html5QrCode) return;
      try {
        isTorchOn = !isTorchOn;
        await html5QrCode.applyVideoConstraints({
          advanced: [{ torch: isTorchOn }],
        });
        toggleTorchBtn.text(isTorchOn ? "Matikan Senter" : "Nyalakan Senter");
      } catch {
        handleError("Senter tidak didukung pada kamera ini");
      }
    }

    // ===========================
    // FLIP CAMERA (MOBILE ONLY)
    // ===========================
    if (isMobile()) {
      const flipBtn = $(`
        <button id="flipCameraBtn" class="btn btn-secondary mt-2 w-100">
          Flip Camera
        </button>
      `);

      $(".scanner-card").append(flipBtn);

      flipBtn.on("click", function () {
        if (!camerasList.length) return;

        currentCameraIndex = (currentCameraIndex + 1) % camerasList.length;

        cameraSelect.val(camerasList[currentCameraIndex].id);

        startScanner();
      });
    }

    // ===========================
    // COPY RESULT
    // ===========================
    copyBtn.on("click", function () {
      const text = resultEl.text();
      if (!text || text === "-") return;

      navigator.clipboard.writeText(text).then(() => {
        copyBtn.text("Tersalin!");
        setTimeout(() => copyBtn.text("Salin Hasil"), 1200);
      });
    });

    // Ganti kamera manual (opsional)
    cameraSelect.on("change", function () {
      const id = $(this).val();
      const foundIndex = camerasList.findIndex((c) => c.id === id);
      if (foundIndex !== -1) currentCameraIndex = foundIndex;
      startScanner();
    });

    startBtn.on("click", startScanner);
    stopBtn.on("click", stopScanner);
    toggleTorchBtn.on("click", toggleTorch);

    // INITIAL
    scanCameras();

    // refresh camera when back to tab
    document.addEventListener("visibilitychange", function () {
      if (document.visibilityState === "visible") scanCameras();
    });
  });
</script>
